---
- name: "Installing homeassistant system dependencies"
  apt: name={{item}} state=present
  become: yes
  with_items:
    - python3-dev
    - nmap
    - libffi-dev # Required by pyatv
    - libssl-dev # Required by pyatv
    - autoconf   # Required by Tr√§dfri

- name: Creating homeassistant directory
  file: path={{homeassistant_dir}} state=directory owner={{homeassistant_user}} group={{homeassistant_group}}
  become: yes

- name: Manually create the initial virtualenv
  command: virtualenv {{homeassistant_venv}} -p python3 creates="{{homeassistant_venv}}"

- name: "Installing homeassistant"
  pip: name=homeassistant virtualenv="{{homeassistant_venv}}" version={{homeassistant_version}}
  notify:
    - restart_homeassistant

# During upgrade, homeassistant runs its own pip install processes
# ubuntu   15885 15869 42 15:01 ?        00:00:02 /opt/homeassistant/.venv/bin/python3 -m pip install
# --quiet sqlalchemy==1.1.14 --upgrade
# --constraint /opt/homeassistant/.venv/lib/python3.5/site-packages/homeassistant/package_constraints.txt

# Installing pyatv (no longer using it and it fails on python 3.6)
# - name: "Installing pyatv"
#   pip: name=pyatv virtualenv="{{homeassistant_venv}}"
#   notify:
#   - restart_homeassistant

- include: patch_python_nest.yml

- name: "Configuring homeassistant automations"
  template: src={{item}} dest={{homeassistant_dir}}/{{item}}
  with_items:
   - automations.yaml
  notify:
    - reload_homeassistant_automations

- name: "Configuring homeassistant"
  template: src={{item}} dest={{homeassistant_dir}}/{{item}}
  with_items:
   - configuration.yaml
   - groups.yaml
   - scenes.yaml
   - scripts.yaml
   - known_devices.yaml
#   - nest.conf # Nest token needs to be refreshed every so often, installing an invalid one messes up HA
   - phue.conf
  notify:
    - reload_homeassistant_config
    - restart_homeassistant

- name: Installing homeassistant systemd service
  template: src=homeassistant.service dest=/etc/systemd/system/{{homeassistant_service}}.service
  notify:
    - daemon_reload
    - restart_homeassistant
  become: yes

- name: Installing some convenience aliases
  template: src=hass-aliases.sh dest=/etc/profile.d/hass-aliases.sh
  become: yes

- name: Make sure homeassistant service is started
  service: name={{homeassistant_service}} state=started enabled=yes
  become: yes

- name: force all notified handlers to run at this point, not waiting until the end (because homeassistant restart is slow)
  meta: flush_handlers
